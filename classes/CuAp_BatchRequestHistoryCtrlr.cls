/******************************************************************************
@author         Echo: Patrick Dixon
@date           26 Jun 2018
@description    Component controller for batch request history lightning component
Revision(s)     
*******************************************************************************/
public with sharing class CuAp_BatchRequestHistoryCtrlr {
    
    private static final String CLASS_NAME = 'CuAp_BatchRequestHistoryCtrlr';
    private static final String DEBUG = '[' + CLASS_NAME + '] ';
    
    private static List<String> contentDocumentFields = new List<String>{
                                                                        'Id', 
                                                                        'ContentSize', 
                                                                        'FileType'
                                                                        };
    private static List<String> batchErrorFields = new List<String>{
                                                                    GlUt_APIConstantsBatchError.ERRORDETAILSAPINAME, 
                                                                    GlUt_APIConstantsBatchError.BATCHREQUESTIDAPINAME
                                                                    };

    /**********************************************************************************************
    @author:        Echo: Patrick Dixon
    @date:          25 Jun 2018                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
    @description:   sub class for tabs
    **********************************************************************************************/
    public class tab {
        
        @AuraEnabled public String tabName;
        @AuraEnabled public Integer numberOfRecords;
        @AuraEnabled public List<BlAp_CombinedRecord> records;
        
        /**********************************************************************************************
        @author:        Echo: Patrick Dixon
        @date:          25 Jun 2018
        @description:   constructor
        **********************************************************************************************/
        public tab(String tabName, List<BlAp_CombinedRecord> records) {
            this.tabName = tabName;
            this.records = records;
            numberOfRecords = records.size();
        }
    }

    /******************************************************************************
    @author         Echo: Patrick Dixon
    @date           26 Jun 2018
    @param          String - the name of the fieldset
    @return         List<GLAp_FieldProps> - liBankAccountDetailisReqForDirectDebitst of field properties for device table
    @description    get the field properties for the Device__c object
    *******************************************************************************/
    @AuraEnabled
    public static List<GLAp_FieldProps> retrieveFieldProperties(String fieldsetName) {
        List<GLAp_FieldProps> fieldPropertiesList = GlAp_LightningDataAccess.getObjectsFieldPropertiesByFieldSetName(GlUt_APIConstantsBatchRequestQueue.BATCHREQQUEUEAPINAME, 
                                                                                                                     fieldsetName);
        
        try {
            GlUt_Logger.logDebug(DEBUG + 'retrieveFieldProperties: ' + fieldsetName);
            
            // make all fields read only
            for (GLAp_FieldProps fieldProperties : fieldPropertiesList) {
                fieldProperties.isEditable = false;
            }
            
            //MT - 24 Aug 2018 Start of AT-3441
            GlAp_FieldProps fieldprop = new GlAp_FieldProps(false, false, true, false, GlUt_APIConstantsBatchRequestQueue.USERAPINAME, LoAp_Constants.NOTIFICATIONUSERFIELDNAME, LoAp_Constants.REFERENCEFIELD, true, GlUt_APIConstantsBatchRequestQueue.USERAPINAME);
            fieldPropertiesList.add(1,fieldprop);
            //End of AT-3441
            
            // add button column
            fieldPropertiesList.add(new GlAp_FieldProps(LoAp_Constants.ACTION, LoAp_Constants.ACTION, true));

        } catch (exception e) {
            GlUt_Logger.logException(e);
            
        } finally {
            GlUt_Logger.writeLogsToDatabase();
        }

        return fieldPropertiesList;
    }
 
    /******************************************************************************
    @author         Echo: Patrick Dixon
    @date           26 Jun 2018
    @param          Id - the record Id
    @param          String - the name of the fieldset
    @return         List<BlAp_CombinedRecord> - list of combined device records to display
    @description    get the list of device records to display
    *******************************************************************************/
    @AuraEnabled
    public static List<BlAp_CombinedRecord> retrieveRecords(Id recordId, String fieldsetName) {
        
        System.debug(DEBUG + 'recordId: ' + recordId);
        List<BlAp_CombinedRecord> recordsToDisplay = new List<BlAp_CombinedRecord>();
        
        try {
            GlUt_Logger.logDebug(DEBUG + 'retrieveRecords: ' + recordId + fieldsetName);
            //MT - 24 Aug 2018 Start of AT-3441
            List<String> lstBatchRequestQueueFields = GlAp_LightningDataAccess.getFieldSetFields(GlUt_APIConstantsBatchRequestQueue.BATCHREQQUEUEAPINAME, fieldsetName);
            lstBatchRequestQueueFields.add(GlUt_APIConstantsBatchRequestQueue.USERAPINAME);
            // check field accessibility and get the records
            List<SObject> records = GlAp_LightningDataAccess.getRecords(GlUt_APIConstantsBatchRequestQueue.BATCHREQQUEUEAPINAME, 
                                                                        lstBatchRequestQueueFields, 
                                                                        recordId, 
                                                                        GlUt_APIConstantsBatchRequestQueue.BATCH_PROCESS, 
                                                                        null, 
                                                                        ' ORDER BY CreatedDate DESC');
                                                                        
            List<Id> lstreferencefield = new List<Id>();
            for(BatchRequestQueue__c objBatchRequestQueue : (List<BatchRequestQueue__c>) records){
                if(objBatchRequestQueue.NotificationUser__c != Null)
                    lstreferencefield.add(objBatchRequestQueue.NotificationUser__c);
            }
            
            Map<Id,String> notificationIdReferenceNameMap = new Map<Id,String>();
            if(!lstreferencefield.isEmpty()){
                notificationIdReferenceNameMap = GlAp_LightningDataAccess.getRecordName(lstreferencefield);
            }                                                          
            //End of AT-3441
            
            // build the display list
            for (SObject record : records) {
                BlAp_CombinedRecord recordToDisplay = new BlAp_CombinedRecord();            
                recordToDisplay.uniqueId = record.Id;
                recordToDisplay.isSelected = false;
                recordToDisplay.readOnlyFields = new Map<String, Boolean>();
                recordToDisplay.objectMap = GlAp_LightningDataAccess.getRecordMapWithFields(GlUt_APIConstantsBatchRequestQueue.BATCHREQQUEUEAPINAME, record);
                
                //MT - 24 Aug 2018 Start of AT-3441
                recordToDisplay .transformFieldMap = new Map<String,Map<String,String>>();
                if(!notificationIdReferenceNameMap.isEmpty()){
                    Map<String,String> notificationTransformFieldMap = new Map<String,String>();
                    String notificationId = (String)record.get(GlUt_APIConstantsBatchRequestQueue.USERAPINAME);
                    notificationTransformFieldMap.put(notificationId,
                                                      notificationIdReferenceNameMap.get(notificationId));
                    recordToDisplay.transformFieldMap.put(GlUt_APIConstantsBatchRequestQueue.USERAPINAME ,notificationTransformFieldMap);
                }
                //End of AT-3441

                // initialise the button attributes
                recordToDisplay.buttonAttributes = new List<BlAp_CombinedRecord.ButtonAttribute>();
                
                // add cancel button display attributes
                BatchRequestQueue__c batchRequestQueue = (BatchRequestQueue__c)record;
                String buttonStatus = (batchRequestQueue.Status__c == Label.GlAp_Initialised 
                        || batchRequestQueue.Status__c == Label.GlAp_Processing
                        || batchRequestQueue.Status__c == Label.GlAp_Pending) ? CuAp_Constants.BUTTON_ACTIVE : CuAp_Constants.BUTTON_INACTIVE;
                            
                recordToDisplay.buttonAttributes.add(new BlAp_CombinedRecord.ButtonAttribute(LoAp_Constants.ACTION, 
                                                                                    LoAp_Constants.CANCEL, 
                                                                                    buttonStatus));

                recordsToDisplay.add(recordToDisplay);           
                System.debug(DEBUG + 'recordToDisplay: ' + recordToDisplay);
            }

        } catch (exception e) {
            GlUt_Logger.logException(e);
            
        } finally {
            GlUt_Logger.writeLogsToDatabase();
        }
        
        return recordsToDisplay;
    }
    
    /******************************************************************************
    @author         Echo: Patrick Dixon
    @date           26 Jun 2018
    @parameter      Id batchProcessId - Id of the batch process record
    @parameter      Id batchRequestQueueId - Id of the batch request queue record
    @parameter      String fieldsetName - name of the staging table fieldset
    @return         Map<String, List<GLAp_FieldProps>> - list of field properties for each tab keyed on tab name
    @description    gets a map of the tab field properties
    *******************************************************************************/
    @AuraEnabled
    public static Map<String, List<GLAp_FieldProps>> retrieveTabFieldProperties(Id batchProcessId) {
        Map<String, List<GLAp_FieldProps>> tabFields = new Map<String, List<GLAp_FieldProps>>();
        
        try {
            GlUt_Logger.logDebug(DEBUG + 'getTabFieldProperties: ' + batchProcessId);
            
            tabFields.put(Label.GlAp_FilesTab, GlAp_BatchRequestQueueCtrlr.retrieveFieldPropDetails('ContentDocument', contentDocumentFields));
            tabFields.put(Label.GlAp_ErrorsTab, GlAp_BatchRequestQueueCtrlr.retrieveFieldPropDetails(GlUt_APIConstantsBatchError.BATCHERRORAPINAME, batchErrorFields));
            
        } catch (exception e) {
            GlUt_Logger.logException(e);
            system.debug('Error: ' + e.getMessage());
            
        } finally {
            GlUt_Logger.writeLogsToDatabase();
        }
        
        return tabFields;
    }

    /******************************************************************************
    @author         Echo: Patrick Dixon
    @date           26 Jun 2018
    @parameter      Id batchProcessId - Id of the batch process record
    @parameter      Id batchRequestQueueId - Id of the batch request queue record
    @parameter      String fieldsetName - name of the staging table fieldset
    @return         List<tab> - the tabs
    @description    gets the related tab records
    *******************************************************************************/
    @AuraEnabled
    public static List<tab> getTabRecords(Id batchProcessId, Id batchRequestQueueId) {
        List<tab> tabs = new List<tab>();
        
        try {
            GlUt_Logger.logDebug(DEBUG + 'getTabRecords: ' + batchProcessId + ' - ' + batchRequestQueueId);
            
            tabs.add(new tab(Label.GlAp_FilesTab, 
                            GlAp_BatchRequestQueueCtrlr.retrieveFilesRecords('ContentDocument', contentDocumentFields, batchRequestQueueId)));
        
            tabs.add(new tab(Label.GlAp_ErrorsTab, 
                            GlAp_BatchRequestQueueCtrlr.retrieveErrorRecords(GlUt_APIConstantsBatchError.BATCHERRORAPINAME, batchErrorFields, batchRequestQueueId)));

        } catch (exception e) {
            GlUt_Logger.logException(e);
            system.debug('Error: ' + e.getMessage());
            
        } finally {
            GlUt_Logger.writeLogsToDatabase();
        }
        
        return tabs;
    }

    /******************************************************************************
    @author         Echo: Patrick Dixon
    @date           29 Jun 2018
    @parameter      Id batchRequestQueueId - Id of the batch request queue record
    @description    cancels the batch request queue
    *******************************************************************************/
    @AuraEnabled
    public static void cancelBatchRequestQueue(Id batchRequestQueueId) {
        try {
            GlUt_Logger.logDebug(DEBUG + 'cancelBatchRequestQueue: ' + batchRequestQueueId);
            GlAp_BatchRequestQueueCtrlr.cancelledStatus(batchRequestQueueId);       // TO-DO - the called method should be in a utility class
        } 
        catch (exception e) {
            GlUt_Logger.logException(e);
        } 
        finally {   
            GlUt_Logger.writeLogsToDatabase();
        }

    }
}